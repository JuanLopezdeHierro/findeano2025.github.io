<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fin de A√±o 2025 | Global View</title>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], serif: ['Playfair Display', 'serif'] },
                    colors: {
                        gold: '#D4AF37',
                        goldlight: '#F3E5AB',
                        dark: '#0a0a0a',
                        glass: 'rgba(255, 255, 255, 0.05)',
                    },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out', 'slide-up': 'slideUp 0.3s ease-out' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #050505;
            color: #E0E0E0;
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #050505 70%);
        }

        .glass-panel {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(212, 175, 55, 0.15);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .gold-gradient-text {
            background: linear-gradient(to right, #D4AF37, #F3E5AB, #D4AF37);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% auto;
            animation: shine 4s linear infinite;
        }

        .gold-btn {
            background: linear-gradient(135deg, #D4AF37 0%, #B49020 100%);
            color: #000;
        }

        @keyframes shine {
            to {
                background-position: 200% center;
            }
        }

        /* Table Styles */
        th {
            font-family: 'Playfair Display', serif;
            letter-spacing: 0.05em;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // ‚úÖ URL ACTUALIZADA
        const API_URL = 'https://script.google.com/macros/s/AKfycbwLyxuAZFYfmUyS7Q-CjBrK0RZ3KKoD7M6wyYC11WC4raZZlf8XeKetj9xB2lY5yeCgAQ/exec';

        const USERS = ['Juan', 'Quintana', 'Germ√°n', 'Jose', 'Cantero', 'Alejandro', 'David', 'Jorge', 'Arbelo'];

        const TASK_CONFIG = {
            alcohol: { icon: 'üç∑', label: 'Alcohol', desc: 'Barra libre', options: ['Vodka', 'Ron', 'Ginebra', 'Whisky', 'Jaggermeister', 'Refrescos', 'Hielo', 'OTRO'], unit: 'ml/L', budget: 112.5 },
            musica: { icon: 'üéµ', label: 'M√∫sica', desc: 'Sonido', options: ['Altavoz', 'Cableado', 'Luces', 'Playlist', 'OTRO'], unit: 'Info', budget: 20 },
            logistica: { icon: 'üöò', label: 'Log√≠stica', desc: 'Transporte', options: [], unit: '', budget: 0 },
            snacks: { icon: 'üç™', label: 'Snacks', desc: 'Picoteo', options: ['Munchitos', 'Gusanitos', 'Papas Lays', 'Doritos', 'Aceitunas', 'Frutos Secos', 'OTRO'], unit: 'bolsas', budget: 67.5 },
            menaje: { icon: 'üçΩÔ∏è', label: 'Menaje', desc: 'Cristaler√≠a', options: ['Vasos tubo', 'Vasos chupito', 'Platos', 'Servilletas', 'OTRO'], unit: 'uds', budget: 22.5 }
        };

        const Toast = ({ message, type, onClose }) => {
            React.useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, []);
            return (
                <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-[100] flex items-center gap-3 px-6 py-3 rounded-full shadow-2xl animate-fade-in border ${type === 'error' ? 'bg-red-900/90 border-red-500 text-white' : 'bg-dark/90 border-gold text-gold'}`}>
                    <span>{type === 'error' ? '‚ö†Ô∏è' : '‚ú®'}</span><span className="text-sm font-medium">{message}</span>
                </div>
            );
        };

        const BudgetBar = ({ current, max }) => {
            if (max === 0) return null;
            const percentage = Math.min((current / max) * 100, 100);
            const isOver = current > max;
            const remaining = max - current;
            return (
                <div className="mt-2 mb-4">
                    <div className="flex justify-between text-[10px] uppercase tracking-wider mb-1">
                        <span className={isOver ? 'text-red-400 font-bold' : 'text-gold'}>Gastado: {current.toFixed(2)}‚Ç¨</span>
                        <span className="text-gray-500">Presupuesto: {max.toFixed(2)}‚Ç¨</span>
                    </div>
                    <div className="h-2 w-full bg-gray-800 rounded-full overflow-hidden border border-white/5">
                        <div className={`h-full transition-all duration-500 ${isOver ? 'bg-red-600' : 'bg-gradient-to-r from-gold to-yellow-600'}`} style={{ width: `${percentage}%` }} />
                    </div>
                    <div className="text-right mt-1">
                        <span className={`text-[10px] ${remaining < 0 ? 'text-red-500 font-bold' : 'text-green-500'}`}>
                            {remaining < 0 ? `‚ö†Ô∏è Exceso: ${Math.abs(remaining).toFixed(2)}‚Ç¨` : `Disponible: ${remaining.toFixed(2)}‚Ç¨`}
                        </span>
                    </div>
                </div>
            );
        };

        // --- PESTA√ëAS ---
        const PlanningTab = ({ tasks, user, hasChanges, saving, toggleAssignment, handleDetailChange, handleCostChange, addItem, tempInputs, updateTempInput, saveData }) => (
            <div className="space-y-6 pb-24 animate-slide-up">
                {Object.entries(tasks).map(([key, task]) => {
                    const config = TASK_CONFIG[key];
                    const isAssigned = task.assignedTo.includes(user);
                    const inputs = tempInputs[key] || {};
                    const defaultOption = config.options.length > 0 ? config.options[0] : '';
                    const currentSelection = inputs.selectedOption || defaultOption;

                    return (
                        <div key={key} className={`glass-panel rounded-xl overflow-hidden transition-all duration-300 ${isAssigned ? 'border-gold/40 shadow-[0_0_15px_rgba(212,175,55,0.1)]' : 'opacity-85'}`}>
                            <div className="p-5">
                                <div className="flex items-start justify-between mb-2">
                                    <div className="flex items-center gap-4">
                                        <span className="text-3xl filter drop-shadow-lg">{config.icon}</span>
                                        <div>
                                            <h3 className="font-serif font-bold text-xl tracking-wide text-gray-100">{config.label}</h3>
                                            <div className="flex flex-wrap gap-1 mt-1">
                                                {task.assignedTo.length > 0 ? task.assignedTo.map(p => (
                                                    <span key={p} className="text-[10px] uppercase tracking-wider bg-gold/10 text-goldlight px-2 py-0.5 rounded border border-gold/20">{p}</span>
                                                )) : <span className="text-[10px] text-gray-600 italic">Sin asignar</span>}
                                            </div>
                                        </div>
                                    </div>
                                    <button onClick={() => toggleAssignment(key)} className={`px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-widest transition-all ${isAssigned ? 'bg-red-500/10 text-red-400 border border-red-500/30' : 'bg-gold/10 text-gold border border-gold/30'}`}>
                                        {isAssigned ? 'Salir' : 'Entrar'}
                                    </button>
                                </div>
                                {config.budget > 0 && <BudgetBar current={task.cost || 0} max={config.budget} />}
                                {isAssigned ? (
                                    <div className="space-y-4 animate-fade-in bg-black/20 p-3 rounded-lg border border-white/5">
                                        <div className="flex flex-col gap-2">
                                            <div className="flex gap-2 items-end">
                                                <div className="flex-1">
                                                    <label className="text-[9px] text-gray-500 uppercase tracking-widest mb-1 block">Item</label>
                                                    {config.options.length > 0 ? (
                                                        <select className="w-full bg-dark text-sm text-gray-200 p-2 rounded border border-gray-700 focus:border-gold outline-none" onChange={(e) => updateTempInput(key, 'selectedOption', e.target.value)} value={currentSelection}>
                                                            {config.options.map(opt => <option key={opt} value={opt}>{opt === 'OTRO' ? '‚úèÔ∏è Otro...' : opt}</option>)}
                                                        </select>
                                                    ) : (
                                                        <input type="text" placeholder="Item..." className="w-full bg-dark text-sm text-gray-200 p-2 rounded border border-gray-700 focus:border-gold outline-none" onChange={(e) => updateTempInput(key, 'item', e.target.value)} value={inputs.item || ''} />
                                                    )}
                                                </div>
                                                <div className="w-16">
                                                    <label className="text-[9px] text-gray-500 uppercase tracking-widest mb-1 block">Cant.</label>
                                                    <input type="text" placeholder="0" className="w-full bg-dark text-sm text-gray-200 p-2 rounded border border-gray-700 focus:border-gold outline-none" onChange={(e) => updateTempInput(key, 'qty', e.target.value)} value={inputs.qty || ''} />
                                                </div>
                                                <div className="w-16">
                                                    <label className="text-[9px] text-gray-500 uppercase tracking-widest mb-1 block">‚Ç¨ Est.</label>
                                                    <input type="number" placeholder="‚Ç¨" className="w-full bg-dark text-sm text-gray-200 p-2 rounded border border-gray-700 focus:border-gold outline-none" onChange={(e) => updateTempInput(key, 'price', e.target.value)} value={inputs.price || ''} />
                                                </div>
                                                <button onClick={() => addItem(key, config)} className="gold-btn h-[38px] w-[38px] rounded flex items-center justify-center shadow-lg hover:scale-105 transition-transform">‚ûï</button>
                                            </div>
                                            {currentSelection === 'OTRO' && <input type="text" placeholder="Nombre espec√≠fico..." className="w-full bg-dark text-sm text-gold p-2 rounded border border-gold/40 outline-none" onChange={(e) => updateTempInput(key, 'customName', e.target.value)} value={inputs.customName || ''} />}
                                        </div>
                                        <textarea value={task.details} onChange={(e) => handleDetailChange(key, e.target.value)} className="w-full bg-transparent text-sm text-gray-300 p-2 rounded border border-gray-700/50 focus:border-gold outline-none h-32 font-mono leading-relaxed placeholder-gray-700" placeholder="Lista de items..." />
                                        <div className="flex items-center gap-2 border-t border-white/5 pt-2 justify-between">
                                            <span className="text-[10px] text-gray-500 uppercase italic">El coste se escanea del texto</span>
                                            <div className="flex items-center gap-2">
                                                <label className="text-[10px] text-gold uppercase font-bold">TOTAL (‚Ç¨):</label>
                                                <input type="number" value={task.cost || 0} onChange={(e) => handleCostChange(key, e.target.value)} className="bg-transparent text-gold font-bold w-16 text-right focus:outline-none border-b border-white/10 focus:border-gold" />
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="py-2 text-center border-t border-white/5 mt-2"><p className="text-gray-600 text-xs flex items-center justify-center gap-2">üîí Ap√∫ntate para gestionar</p></div>
                                )}
                            </div>
                        </div>
                    );
                })}
                {hasChanges && <div className="fixed bottom-24 left-0 right-0 px-6 flex justify-center z-40 animate-slide-up"><button onClick={saveData} disabled={saving} className={`flex items-center gap-3 px-8 py-3 rounded-full font-bold shadow-[0_0_20px_rgba(212,175,55,0.4)] text-dark text-sm tracking-widest uppercase transform transition-all duration-300 hover:scale-105 ${saving ? 'bg-gray-400' : 'gold-btn animate-pulse'}`}>{saving ? 'Guardando...' : 'üíæ Actualizar Todo'}</button></div>}
            </div>
        );

        // --- NUEVA PESTA√ëA: TABLA RESUMEN ---
        const TableTab = ({ tasks }) => {
            const totalGlobal = Object.values(tasks).reduce((acc, t) => acc + (t.cost || 0), 0);
            return (
                <div className="animate-slide-up pb-24">
                    <div className="glass-panel p-6 rounded-xl mb-6 text-center">
                        <h2 className="font-serif text-2xl text-gold mb-1">Tabla Global</h2>
                        <p className="text-gray-400 text-xs tracking-widest uppercase">Vista de Base de Datos</p>
                    </div>
                    <div className="glass-panel overflow-hidden rounded-xl border border-white/10">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left border-collapse">
                                <thead>
                                    <tr className="bg-white/5 text-gold text-[10px] uppercase tracking-wider border-b border-white/10">
                                        <th className="p-4 font-normal">Tarea</th>
                                        <th className="p-4 font-normal">Equipo</th>
                                        <th className="p-4 font-normal">Detalles</th>
                                        <th className="p-4 font-normal text-right">Gasto</th>
                                    </tr>
                                </thead>
                                <tbody className="text-sm text-gray-300 divide-y divide-white/5">
                                    {Object.entries(tasks).map(([key, task]) => (
                                        <tr key={key} className="hover:bg-white/5 transition-colors">
                                            <td className="p-4 font-serif text-gold whitespace-nowrap">{TASK_CONFIG[key].label}</td>
                                            <td className="p-4 text-xs">{task.assignedTo.length ? task.assignedTo.join(', ') : <span className="opacity-30">-</span>}</td>
                                            <td className="p-4 text-xs font-mono text-gray-400 whitespace-pre-line min-w-[150px]">{task.details || <span className="opacity-30">Sin detalles</span>}</td>
                                            <td className="p-4 text-right font-mono text-gold">{(task.cost || 0).toFixed(2)}‚Ç¨</td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot>
                                    <tr className="bg-gold/10 font-bold text-gold border-t border-gold/20">
                                        <td colSpan="3" className="p-4 text-right uppercase text-xs tracking-widest">Total Fiesta</td>
                                        <td className="p-4 text-right font-mono text-lg">{totalGlobal.toFixed(2)}‚Ç¨</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const EventTab = () => (
            <div className="space-y-6 animate-slide-up">
                <div className="glass-panel p-6 rounded-xl text-center">
                    <h2 className="font-serif text-2xl text-gold mb-2">Presupuesto Total</h2>
                    <p className="text-gray-400 text-sm">Control Financiero</p>
                    <div className="my-6 border-t border-white/10 w-1/2 mx-auto"></div>
                    <div className="grid grid-cols-2 gap-4 text-sm">
                        <div className="bg-white/5 p-4 rounded-lg"><span className="block text-gold text-xs uppercase tracking-widest mb-1">Total Presupuesto</span><span className="text-xl font-bold">222.50‚Ç¨</span></div>
                        <div className="bg-white/5 p-4 rounded-lg"><span className="block text-gray-400 text-xs uppercase tracking-widest mb-1">Estado</span><span className="text-xl font-bold text-green-500">Activo</span></div>
                    </div>
                </div>
            </div>
        );

        const TeamTab = ({ tasks }) => (
            <div className="space-y-4 animate-slide-up pb-20">
                <h2 className="font-serif text-xl text-gold mb-4 px-2">Estado del Equipo</h2>
                {Object.entries(tasks).map(([key, task]) => (
                    <div key={key} className="glass-panel p-4 rounded-xl flex items-center justify-between">
                        <div className="flex items-center gap-3"><span className="text-2xl">{TASK_CONFIG[key].icon}</span><div className="flex flex-col"><span className="text-sm font-medium text-gray-200">{TASK_CONFIG[key].label}</span><span className="text-[10px] text-gold">Gastado: {(task.cost || 0).toFixed(2)}‚Ç¨</span></div></div>
                        <div className="flex -space-x-2">{task.assignedTo.length > 0 ? task.assignedTo.map((p, i) => (<div key={i} className="w-8 h-8 rounded-full bg-gradient-to-br from-gold to-yellow-700 flex items-center justify-center text-[10px] text-black font-bold border-2 border-dark" title={p}>{p.charAt(0)}</div>)) : <span className="text-xs text-gray-600">--</span>}</div>
                    </div>
                ))}
            </div>
        );

        function App() {
            const [activeTab, setActiveTab] = React.useState('planning');
            const [user, setUser] = React.useState('');
            const [tasks, setTasks] = React.useState({});
            const [loading, setLoading] = React.useState(true);
            const [saving, setSaving] = React.useState(false);
            const [hasChanges, setHasChanges] = React.useState(false);
            const [toast, setToast] = React.useState(null);
            const [tempInputs, setTempInputs] = React.useState({});

            React.useEffect(() => { fetchData(); }, []);
            const showToast = (msg, type = 'success') => setToast({ message: msg, type });

            const calculateCostFromText = (text) => {
                if (!text) return 0;
                const regex = /\(Est\.\s*([\d\.]+)\s*‚Ç¨\)/g;
                let total = 0; let match;
                while ((match = regex.exec(text)) !== null) { const val = parseFloat(match[1]); if (!isNaN(val)) total += val; }
                return total;
            };

            const fetchData = async () => {
                try {
                    const response = await fetch(API_URL);
                    const data = await response.json();
                    setTasks(data);
                    setHasChanges(false);
                } catch (err) { showToast('Error cargando datos', 'error'); } finally { setLoading(false); }
            };

            const saveData = async () => {
                setSaving(true);
                try {
                    const params = new URLSearchParams({ action: 'save', data: JSON.stringify(tasks) });
                    const response = await fetch(`${API_URL}?${params.toString()}`);
                    const result = await response.json();
                    if (result.success) { setHasChanges(false); showToast('Datos guardados correctamente'); } else throw new Error();
                } catch (err) { showToast('Error al guardar', 'error'); } finally { setSaving(false); }
            };

            const toggleAssignment = (taskId) => {
                if (!user) return showToast('Selecciona tu nombre primero', 'error');
                setTasks(prev => {
                    const current = prev[taskId].assignedTo;
                    const newAssigned = current.includes(user) ? current.filter(u => u !== user) : [...current, user];
                    return { ...prev, [taskId]: { ...prev[taskId], assignedTo: newAssigned } };
                });
                setHasChanges(true);
            };

            const handleDetailChange = (taskId, value) => {
                const newCost = calculateCostFromText(value);
                setTasks(prev => ({ ...prev, [taskId]: { ...prev[taskId], details: value, cost: newCost } }));
                setHasChanges(true);
            };

            const handleCostChange = (taskId, value) => {
                const numValue = parseFloat(value) || 0;
                setTasks(prev => ({ ...prev, [taskId]: { ...prev[taskId], cost: numValue } }));
                setHasChanges(true);
            };

            const addItem = (taskId, config) => {
                const inputs = tempInputs[taskId] || {};
                let itemName = inputs.selectedOption || (config.options.length > 0 ? config.options[0] : '');
                if (itemName === 'OTRO') itemName = inputs.customName; else if (config.options.length === 0) itemName = inputs.item;
                const qty = inputs.qty || '';
                const priceEst = parseFloat(inputs.price) || 0;
                const priceText = priceEst > 0 ? `(Est. ${priceEst}‚Ç¨)` : '';
                if (!itemName) return;
                const textToAdd = `‚Ä¢ ${itemName}: ${qty} ${config.unit.replace('/Info', '')} ${priceText}`;
                const currentDetails = tasks[taskId].details || '';
                const newDetails = currentDetails ? `${currentDetails}\n${textToAdd}` : textToAdd;
                handleDetailChange(taskId, newDetails);
                setTempInputs(prev => ({ ...prev, [taskId]: { ...prev[taskId], qty: '', customName: '', item: '', price: '' } }));
            };

            const updateTempInput = (taskId, field, value) => { setTempInputs(prev => ({ ...prev, [taskId]: { ...prev[taskId] || {}, [field]: value } })); };

            if (loading) return <div className="min-h-screen flex flex-col items-center justify-center bg-dark text-gold"><div className="animate-spin text-4xl mb-4">‚ú®</div></div>;

            return (
                <div className="min-h-screen font-sans selection:bg-gold selection:text-black">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    <div className="max-w-md mx-auto min-h-screen flex flex-col">
                        <div className="pt-8 pb-6 text-center px-4">
                            <h1 className="font-serif text-4xl gold-gradient-text font-bold mb-2">FIN DE A√ëO 2025</h1>
                            <p className="text-gray-500 text-[10px] tracking-[0.3em] uppercase">Control Presupuestario</p>
                        </div>
                        {activeTab === 'planning' && (
                            <div className="px-4 mb-6">
                                <div className="glass-panel p-3 rounded-lg flex items-center gap-3">
                                    <span className="text-xl">üë§</span>
                                    <select value={user} onChange={(e) => setUser(e.target.value)} className="w-full bg-transparent text-gray-200 text-sm focus:outline-none cursor-pointer">
                                        <option value="" className="bg-dark text-gray-500">¬øQui√©n eres?</option>
                                        {USERS.map(u => <option key={u} value={u} className="bg-dark">{u}</option>)}
                                    </select>
                                </div>
                            </div>
                        )}
                        <div className="flex-1 px-4">
                            {activeTab === 'planning' && <PlanningTab {...{ tasks, user, hasChanges, saving, toggleAssignment, handleDetailChange, handleCostChange, addItem, tempInputs, updateTempInput, saveData }} />}
                            {activeTab === 'table' && <TableTab tasks={tasks} />}
                            {activeTab === 'event' && <EventTab />}
                            {activeTab === 'team' && <TeamTab tasks={tasks} />}
                        </div>
                        <div className="fixed bottom-0 left-0 right-0 bg-dark/90 backdrop-blur-xl border-t border-white/10 z-50">
                            <div className="max-w-md mx-auto flex justify-around p-2">
                                {[
                                    { id: 'planning', icon: 'üìù', label: 'Planning' },
                                    { id: 'table', icon: 'üìä', label: 'Tabla' },
                                    { id: 'event', icon: 'üé©', label: 'Evento' },
                                    { id: 'team', icon: 'üë•', label: 'Equipo' }
                                ].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center gap-1 p-2 w-16 rounded-lg transition-all duration-300 ${activeTab === tab.id ? 'text-gold' : 'text-gray-600 hover:text-gray-400'}`}>
                                        <span className={`text-xl transform transition-transform ${activeTab === tab.id ? '-translate-y-1' : ''}`}>{tab.icon}</span>
                                        <span className="text-[9px] uppercase tracking-widest font-medium">{tab.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>